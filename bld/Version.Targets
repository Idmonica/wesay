<?xml version="1.0" encoding="utf-8"?>

<Project DefaultTargets="Main" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!-- From http://msbuildtasks.tigris.org/ -->
  <Import Project="$(MSBuildExtensionsPath)\MSBuildCommunityTasks\MSBuild.Community.Tasks.Targets"/>

  <PropertyGroup>
	<ApplicationName>WeSay</ApplicationName>
	<Company>WeSay</Company>
	<Copyright>Copyright Â© WeSay 2006-2008</Copyright>

	<Major>0</Major>
	<Minor>4</Minor>
	<Revision></Revision><!-- filled in by subversion version number below-->
	<Bug>0</Bug>

	<Version>0</Version><!-- changed by DetermineVersion version number below-->
  </PropertyGroup>







<Target Name="DetermineVersion">
	<!--
	You must install the subversion package (not tortoise or another fancy gui version)
	http://subversion.tigris.org/project_packages.html
	-->
	<Message Text="b4 DetermineVersion: $(Version)"/>

	<!-- $(Revision) is now passed in from TeamCity which is more portable across version control systems -->
	<!--
	<SvnVersion LocalPath="$(MSBuildProjectDirectory)">
		<Output TaskParameter="Revision" PropertyName="Revision" />
		<Output TaskParameter="Revision" PropertyName="AssemblyRevision"/>
		<Output TaskParameter="Revision" PropertyName="AssemblyFileRevision"/>
	</SvnVersion>
	-->

	<!-- todo: I wanted to now set the Version property, but it seems imposible to affect the property in the outer scope.  There is a bug report here:  http://connect.microsoft.com/VisualStudio/feedback/ViewFeedback.aspx?FeedbackID=110713 -->
</Target>



<Target Name="Version">
	<CallTarget targets="DetermineVersion"/>
	<Message Text="After DetermineVersion: $(Revision)"/>
</Target>

  <!-- From http://www.gotdotnet.com/codegallery/codegallery.aspx?id=93d23e13-c653-4815-9e79-16107919f93e -->
  <!--  <Import Project="$(MSBuildExtensionsPath)\Microsoft\AssemblyInfoTask\Microsoft.VersionNumber.targets"/> -->
  <!-- instead of importing here, we include the actual file with modifications specific to this project (subversion)-->

  <!-- This targets file includes all the necessary information to automatically increment build numbers as part of
	 a regular build process. To use it simply include it in your project file after any other includes. The typical
	 include line looks like this:

	 <Import Project="$(MSBuildExtensionsPath)\Microsoft\AssemblyInfoTask\Microsoft.VersionNumber.targets"/>
  -->
  <!-- Properties for controlling the Assembly Version -->
  <PropertyGroup>
	<AssemblyMajorVersion>$(Major)</AssemblyMajorVersion>
	<AssemblyMinorVersion>$(Minor)</AssemblyMinorVersion>
	<AssemblyBuildNumber>$(Revision)</AssemblyBuildNumber>
	<AssemblyBuildNumberType>NoIncrement</AssemblyBuildNumberType>
	<AssemblyBuildNumberFormat>0</AssemblyBuildNumberFormat>
	<AssemblyRevision>$(Bug)</AssemblyRevision>
	<AssemblyRevisionType>NoIncrement</AssemblyRevisionType>
	<AssemblyRevisionFormat>0</AssemblyRevisionFormat>
  </PropertyGroup>

  <!-- Properties for controlling the Assembly File Version -->
  <PropertyGroup>
	<AssemblyFileMajorVersion>$(Major)</AssemblyFileMajorVersion>
	<AssemblyFileMinorVersion>$(Minor)</AssemblyFileMinorVersion>
	<AssemblyFileBuildNumber>$(Revision)</AssemblyFileBuildNumber>
	<AssemblyFileBuildNumberType>NoIncrement</AssemblyFileBuildNumberType>
	<AssemblyFileBuildNumberFormat>0</AssemblyFileBuildNumberFormat>
	<AssemblyFileRevision>$(Bug)</AssemblyFileRevision>
	<AssemblyFileRevisionType>NoIncrement</AssemblyFileRevisionType>
	<AssemblyFileRevisionFormat>0</AssemblyFileRevisionFormat>
  </PropertyGroup>

  <!-- Properties for controlling COM visibility -->
  <PropertyGroup>
	<AssemblyComVisible></AssemblyComVisible>
	<AssemblyGuid></AssemblyGuid>
  </PropertyGroup>

  <!-- Propeties for controlling extended assembly attributes -->
  <PropertyGroup>
	<AssemblyCompany>$(Company)</AssemblyCompany>
	<AssemblyConfiguration>$(Configuration)</AssemblyConfiguration>
	<AssemblyCopyright>$(Copyright)</AssemblyCopyright>
	<AssemblyCulture></AssemblyCulture>
	<AssemblyDescription></AssemblyDescription>
	<AssemblyProduct>$(ApplicationName)</AssemblyProduct>
	<AssemblyTitle></AssemblyTitle>
  </PropertyGroup>

  <!-- Properties for controlling key signing through assemblyinfo files -->
  <PropertyGroup>
	<AssemblyIncludeSigningInformation>false</AssemblyIncludeSigningInformation>
	<AssemblyDelaySign>false</AssemblyDelaySign>
	<AssemblyKeyFile></AssemblyKeyFile>
	<AssemblyKeyName></AssemblyKeyName>
  </PropertyGroup>

  <!-- The items that get processed by the task
	Add all AssemblyInfo files in all sub-directories to the list of
	files that should be processed by the task but don't include ones under
	subversion's special directory
	-->
  <ItemGroup>
	<AssemblyInfoFiles Include="**\AssemblyInfo.*" Exclude="**\.svn\**\*.*"/>
  </ItemGroup>

  <!-- Import the task -->
  <UsingTask AssemblyName="AssemblyInfoTask, Version=1.0.51130.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35" TaskName="AssemblyInfo"/>

  <!-- Re-define CoreCompileDependsOn to ensure the assemblyinfo files are updated before compilation. -->
  <PropertyGroup>
	<CoreCompileDependsOn>
	  $(CoreCompileDependsOn);
	  Version;
	  UpdateAssemblyInfoFiles
	</CoreCompileDependsOn>
  </PropertyGroup>

  <!-- The target that acutally does all the work. The inputs are the same as the CoreCompileDependsOn target
  (with the addition of @(AssemblyInfoFiles) to ensure that we only ever update the AssemblyInfo files if a
  compile is actually going to take place. The outputs are the AssemblyInfoFiles that were passed in for update. -->
  <Target Name="UpdateAssemblyInfoFiles"
		  Inputs="$(MSBuildAllProjects);
				@(Compile);
				@(ManifestResourceWithNoCulture);
				$(ApplicationIcon);
				$(AssemblyOriginatorKeyFile);
				@(ManifestNonResxWithNoCultureOnDisk);
				@(ReferencePath);
				@(CompiledLicenseFile);
				@(EmbeddedDocumentation);
				@(CustomAdditionalCompileInputs);
				@(AssemblyInfoFiles)"
		  Outputs="@(AssemblyInfoFiles);@(IntermediateAssembly)">
	<Message Text="AssemblyVersion: $(AssemblyMajorVersion).$(AssemblyMinorVersion).$(AssemblyBuildNumber).$(AssemblyRevision)"/>
	<Message Text="AssemblyFileVersion: $(AssemblyFileMajorVersion).$(AssemblyFileMinorVersion).$(AssemblyFileBuildNumber).$(AssemblyFileRevision)"/>

	<AssemblyInfo AssemblyInfoFiles="@(AssemblyInfoFiles)"
				  AssemblyVersion="$(AssemblyVersion)"
				  AssemblyMajorVersion="$(AssemblyMajorVersion)"
				  AssemblyMinorVersion="$(AssemblyMinorVersion)"
				  AssemblyBuildNumber="$(AssemblyBuildNumber)"
				  AssemblyRevision="$(AssemblyRevision)"
				  AssemblyBuildNumberType="$(AssemblyBuildNumberType)"
				  AssemblyBuildNumberFormat="$(AssemblyBuildNumberFormat)"
				  AssemblyRevisionType="$(AssemblyRevisionType)"
				  AssemblyRevisionFormat="$(AssemblyRevisionFormat)"
				  AssemblyFileVersion="$(AssemblyFileVersion)"
				  AssemblyFileMajorVersion="$(AssemblyFileMajorVersion)"
				  AssemblyFileMinorVersion="$(AssemblyFileMinorVersion)"
				  AssemblyFileBuildNumber="$(AssemblyFileBuildNumber)"
				  AssemblyFileRevision="$(AssemblyFileRevision)"
				  AssemblyFileBuildNumberType="$(AssemblyFileBuildNumberType)"
				  AssemblyFileBuildNumberFormat="$(AssemblyFileBuildNumberFormat)"
				  AssemblyFileRevisionType="$(AssemblyFileRevisionType)"
				  AssemblyFileRevisionFormat="$(AssemblyFileRevisionFormat)"
				  ComVisible="$(AssemblyComVisible)"
				  AssemblyGuid="$(AssemblyGuid)"
				  AssemblyCompany="$(AssemblyCompany)"
				  AssemblyConfiguration="$(AssemblyConfiguration)"
				  AssemblyCopyright="$(AssemblyCopyright)"
				  AssemblyCulture="$(AssemblyCulture)"
				  AssemblyDescription="$(AssemblyDescription)"
				  AssemblyProduct="$(AssemblyProduct)"
				  AssemblyTitle="$(AssemblyTitle)"
				  AssemblyIncludeSigningInformation="$(AssemblyIncludeSigningInformation)"
				  AssemblyDelaySign="$(AssemblyDelaySign)"
				  AssemblyKeyFile="$(AssemblyKeyFile)"
				  AssemblyKeyName="$(AssemblyKeyName)">
	  <Output TaskParameter="MaxAssemblyVersion" PropertyName="MaxAssemblyVersion"/>
	  <Output TaskParameter="MaxAssemblyFileVersion" PropertyName="MaxAssemblyFileVersion"/>
	</AssemblyInfo>
  </Target>
</Project>