<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
	<PropertyGroup>
		<RootDir>$(teamcity_build_checkoutDir)</RootDir>
	</PropertyGroup>

	<UsingTask TaskName="StampAssemblies" AssemblyFile="$(RootDir)/build/Palaso.BuildTasks.dll" />
	<UsingTask TaskName="MakeWixForDirTree" AssemblyFile="$(RootDir)/build/Palaso.BuildTasks.dll" />
	<UsingTask TaskName="Split" AssemblyFile="$(RootDir)/build/Palaso.BuildTasks.dll" />
	<UsingTask TaskName="FileUpdate" AssemblyFile="$(RootDir)/build/Palaso.BuildTasks.dll" />
	<UsingTask TaskName="DNZip" AssemblyFile="$(RootDir)/build/MSBuild.ExtensionPack.dll" />
	<UsingTask TaskName="File" AssemblyFile="$(RootDir)/build/MSBuild.ExtensionPack.dll" />
	<UsingTask TaskName="NUnitTeamCity" AssemblyFile="$(agent_home_dir)/plugins/dotnetPlugin/bin/JetBrains.BuildServer.MSBuildLoggers.dll" />

	<PropertyGroup>
		<Solution>WeSay.sln</Solution>
		<ApplicationName>WeSay</ApplicationName>
		<Configuration>Release</Configuration>
	</PropertyGroup>

	<Import Project="$(RootDir)/build/build.common.proj" />

	<Target Name="Build">
		<CallTarget Targets="Clean"/>
		<CallTarget Targets="SetAssemblyVersion"/>
		<CallTarget Targets="Compile"/>
		<Message Text="Build Complete"/>
	</Target>

	<ItemGroup>
		<ExistingObjectFiles
			Include="$(RootDir)/**/obj/**/*;$(RootDir)/output/$(Configuration)/**/*"
			Exclude="$(RootDir)/.hg/**/*"
		/>
	</ItemGroup>

	<Target Name="Clean">
		<Delete Files="@(ExistingObjectFiles)" />
		<CallTarget Targets="CleanInstaller" />
	</Target>

	<ItemGroup>
		<ExistingInstallerFiles
			Include="$(RootDir)/output/installer/**/*"
			Exclude="$(RootDir)/.hg/**/*"
		/>
	</ItemGroup>

	<Target Name="CleanInstaller">
		<Delete Files="@(ExistingInstallerFiles)" />
	</Target>

	<Target Name="Compile" DependsOnTargets="">
		<MSBuild
			Projects="$(RootDir)\src\$(Solution)"
			Targets="Build"
			Properties="Configuration=$(Configuration)" />
	</Target>

	<Target Name="Test" DependsOnTargets="Build; UnzipMercurial">
		<CreateItem
			Include="$(RootDir)/output/$(Configuration)/*.Tests.dll"
			Exclude="$(RootDir)/output/$(Configuration)/Palaso.Tests.dll" >
			<Output ItemName="TestAssemblies" TaskParameter="Include" />
		</CreateItem>
		<NUnitTeamCity
			Assemblies="@(TestAssemblies)"
			ExcludeCategory="SkipOnTeamCity;SkipOnBuildServer"
			NUnitVersion="NUnit-2.5.5" />
	</Target>

	<Target Name="UnzipMercurial" DependsOnTargets="">
		<!-- Extract a zip file-->
		<!-- This output path is different from the old wesay, but the same as chorus.  WeSay used to be output/release/mercurial -->
		<DNZip TaskAction="Extract" ExtractPath="$(RootDir)" ZipFileName="$(RootDir)/lib/Release/Mercurial.zip"/>
	</Target>

	<!-- Installer Targets -->
	<ItemGroup>
		<SampleFiles
			Include="$(RootDir)\SampleProjects\src\**\*.*"
			Exclude="" />
	</ItemGroup>

	<ItemGroup>
		<SampleProjects
			Include="$(RootDir)\SampleProjects\src\*.*"
			Exclude="" />
	</ItemGroup>

	<Target Name="CreateSample">
		<Copy
			SourceFiles="@(SampleFiles)"
			DestinationFolder="$(RootDir)\SampleProjects\%(RecursiveDir)" />
	</Target>

	<Target Name="MakePotFile">
		<MakePot
			ProjectId="WeSay"
			OutputFile="$(RootDir)\common\WeSay.pot"
			MsdIdBugsTo="issues@wesay.org"
			XmlFiles="@(XmlFiles)"
			XPathToStrings="//label | //longLabel | //description[not(@UseInConstructor='false')]"
			CSharpFiles="@(CSharpFiles)" />
	</Target>

	<Target Name="MakeWixForPoFiles">
		<MakeWixForDirTree
			DirectoryReferenceId="common"
			ComponentGroupId="PoFiles"
			RootDirectory="$(RootDir)\common"
			OutputFilePath="$(RootDir)\src\Installer\GeneratedPOFiles.wxs"
			MatchRegExPattern="\.po$">
			<Output TaskParameter="OutputFilePath" ItemName="Compile" />
		</MakeWixForDirTree>
	</Target>

	<Target Name="MakeWixForTemplates">
		<MakeWixForDirTree
			DirectoryReferenceId="TemplatesDir"
			ComponentGroupId="templates"
			RootDirectory="$(RootDir)\templates"
			OutputFilePath="$(RootDir)\src\Installer\GeneratedTemplateFiles.wxs"
			MatchRegExPattern=".*" >
			<Output TaskParameter="OutputFilePath" ItemName="Compile" />
		</MakeWixForDirTree>
	</Target>

	<Target Name="MakeWixForDistFiles">
		<CallTarget targets="MakeWixForPoFiles"/>
		<CallTarget targets="MakeWixForTemplates"/>
	</Target>

	<PropertyGroup>
		<ReleaseString Condition="'$(Release)' == 'ALPHA'">-Alpha</ReleaseString>
		<ReleaseString Condition="'$(Release)' == 'BETA'">-Beta</ReleaseString>
	</PropertyGroup>
	<Target Name="Installer" DependsOnTargets="CleanInstaller; VersionNumbers; MakeWixForDistFiles; Build ">
		<!-- set the version number in the installer configuration program.  Perhaps there's a way to just send in the variables rather than this brute-force
		changing of the script, but I haven't figured that out. -->

		<FileUpdate
			File="$(RootDir)\src\Installer\Installer.wxs"
			Regex='Property_ProductVersion = ".*"'
			ReplacementText ="Property_ProductVersion = &quot;$(Version)&quot;" />
		<Message Text="Making WeSay Installer Version: $(Version)" Importance="high"  />

		<MSBuild Projects="$(RootDir)\src\Installer\Installer.wixproj"/>

		<!-- remove an existing one with the same name, if necessary -->
		<Delete
			Files="$(RootDir)\output\installer\WeSayInstaller-$(version).msi"
			TreatErrorsAsWarnings="false" />

		<File
			TaskAction="Move"
			Path="$(RootDir)\output\installer\WeSayInstaller.msi"
			TargetPath="$(RootDir)\output\installer\WeSayInstaller-$(version)$(ReleaseString).msi" />
	</Target>

	<Target Name="Upload" DependsOnTargets="VersionNumbers; Installer" >
		<Message Text="Attempting rsync of WeSayInstaller.$(Version)$(ReleaseString).msi" Importance="high"/>

		<Exec
			Command='"c:\program files\cwRsync\bin\rsync.exe" -vz -e"\"c:\program files\cwRsync\bin\ssh\" -oUserKnownHostsFile=C:\BuildAgent\conf\known_hosts -oIdentityFile=C:\BuildAgent\conf\bob.key -l bob" "output\installer\WeSayInstaller-$(version)$(ReleaseString).msi" bob@wesay.org:/var/www/downloads/WeSayInstaller-$(version)$(ReleaseString).msi'
			WorkingDirectory="$(RootDir)" />
	</Target>

</Project>
